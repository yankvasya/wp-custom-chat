"use strict";(self.webpackChunkwp_custom_chat=self.webpackChunkwp_custom_chat||[]).push([[3],{384:(e,n,t)=>{t.d(n,{kE:()=>r,zb:()=>d});var a=t(629);let i="https://avavatar.ru/images/avatars/2/avatar_X45iWdICzBLrkbJs.jpg",s={id:0,nickname:"",avatar:i},o={friends:[],online:0};function r(e){s.nickname=e,document.querySelector(".profile__nickname").innerText=`${e}`}function c(e,n){if("join"===n)s.nickname!==e&&document.querySelector(".profile__nicknames").insertAdjacentHTML("beforeend",`<li class="nickname">${e}</li>`);else if("leave"===n&&s.nickname!==e){const n=document.querySelector(".profile__nicknames").children;for(let t=0;t<n.length;t++)n[t].innerText===`${e}`&&n[t].remove()}}function l(e,n){const t=document.querySelector("#messageContainer"),a=`<li class="member join">\n                    <div class="member__join">\n                        <div>${e} ${n}</div>\n                    </div>\n                </li>`;t.insertAdjacentHTML("beforeend",a),t.scrollTop=t.scrollHeight}async function d(e,n,t){switch(e){case"addmessage":await function(e,n){const t=document.createElement("li"),a=document.querySelector("#messageContainer");s.avatar;const i={message:e},r=`${(new Date).getHours()>=10?(new Date).getHours():"0"+(new Date).getHours()}:${(new Date).getMinutes()>=10?(new Date).getMinutes():"0"+(new Date).getMinutes()}`,c={fullDate:`${(new Date).getFullYear()}-${(new Date).getMonth()}-${(new Date).getDay()}T${r}`,currentTime:r},l=a.lastElementChild,d=`{"${document.cookie.split("; ").join('" "').split("=").join('":"').split(" ").join(", ")}"}`,m=JSON.parse(d);m.id=Number(m.id);const u=document.querySelector("#addMessageTemplate").innerHTML,f=Handlebars.compile(u),g=document.querySelector("#addFullMessageTemplate").innerHTML,p=Handlebars.compile(g);let v;if(t.classList.add("member"),m.id===n)v=null===l||l.classList.contains("friend")||l.classList.contains("join")?p(Object.assign(s,i,c)):f(Object.assign(m,i,c)),null===l||l.classList.contains("friend")||l.classList.contains("join")?(t.classList.add("me"),a.appendChild(t)):l.insertAdjacentHTML("beforeend",v);else{const e={};o.friends.forEach((t=>{t.id===n&&(e.nickname=t.nickname,e.avatar=t.avatar)})),console.log(e),v=null===l||l.classList.contains("me")||l.classList.contains("join")||0!==l.firstElementChild.textContent.length&&l.firstElementChild.textContent!==e.nickname?p(Object.assign(e,i,c)):f(Object.assign(i,c)),null===l||l.classList.contains("me")||l.classList.contains("join")||l.firstElementChild.textContent!==e.nickname?(t.classList.add("friend"),a.appendChild(t)):l.insertAdjacentHTML("beforeend",v)}t.innerHTML=v,a.scrollTop=a.scrollHeight}(n.message,n.id);break;case"close":await function(e){const n=o.friends;for(let t=0;t<n.length;t++)n[t].id===e&&(o.online--,m(),l(n[t].nickname,"вышел из чата"),c(n[t].nickname,"leave"),o.friends[t]={})}(n.id);break;case"connection":(0,a.MI)(),sessionStorage.getItem("recent-image")?s.avatar=sessionStorage.getItem("recent-image"):s.avatar=i,await function(e){return new Promise((n=>{document.cookie=`id=${e}`,s.id=Number(e);const t=setInterval((()=>{void 0!==s.nickname&&0!==s.nickname.length&&(clearInterval(t),n(JSON.stringify(s)))}),250)}))}(t);break;case"join":await function(e,n,t){return new Promise((()=>{o.friends.push({id:n,nickname:e,avatar:t}),o.online++,m(),l(e,"присоединился к чату"),c(e,"join")}))}(n.message.nickname,n.id,n.message.avatar);break;case"dataBaseInfo":n.id!==s.id&&(0,a.h0)(o,n.id);break;case"takeDataBaseInfo":n.message.id===s.id&&0===o.friends.length&&function(e){o.friends=e.friends,o.online=e.online,m();for(const e of o.friends)void 0!==e.nickname&&c(e.nickname,"join")}(n.message);break;case"newAvatar":await function(e){const n=new FileReader;n.addEventListener("load",(()=>{sessionStorage.setItem("recent-image",n.result),s.avatar=n.result;const e=document.querySelector(".profile__picture"),t=sessionStorage.getItem("recent-image"),i={type:"friendChangeAvatar",payload:{avatar:t}};(0,a.K4)(JSON.stringify(i)),e.src=`${t}`})),n.readAsDataURL(e.files[0])}(n);break;case"friendChangeAvatar":!function(e,n){o.friends.forEach((t=>{t.id===n&&(t.avatar=e)}))}(n.message.avatar,n.id)}}function m(){const e=o.online,n=document.querySelector(".chat__members");!function(e){const t=["участник","участника","участников"];e<0||(1!==e&&21!==e?e>1||e<5||21<e<25?n.innerText=`${e} ${t[1]}`:(e>10||e<20||e>=25||0===e)&&(n.innerText=`${e} ${t[2]}`):n.innerText=`${e} ${t[0]}`)}(e)}},629:(e,n,t)=>{t.d(n,{bG:()=>r,K4:()=>c,MI:()=>l,h0:()=>d});var a=t(384);const i=new WebSocket("ws://localhost:8999"),s=document.querySelector("#messageText");let o;function r(){const e={type:"addmessage",payload:s.value};i.send(JSON.stringify(e)),s.value=""}function c(e){i.send(e)}function l(){i.send(JSON.stringify({type:"dataBaseInfo",payload:{id:o}}))}function d(e,n){const{friends:t,online:a}=e,s={type:"takeDataBaseInfo",payload:{friends:t,online:a,length:t.length,id:n}};t.length>0&&i.send(JSON.stringify(s))}i.addEventListener("message",(function(e){let n;!function e(t){let a=JSON.parse(t);if("object"!=typeof a?e(a):n=a,void 0!==n.message){const{type:e,payload:t}=JSON.parse(n.message);n={type:e,payload:{message:t,id:n.id}}}}(e.data);const{type:t,payload:i}=n;if(void 0===o)return(0,a.zb)(t,null,i.id).then((e=>e)),o=i.id,void console.warn(`Текущее ID пользователя: ${o}`);(0,a.zb)(t,i).then((e=>{}))})),i.addEventListener("error",(function(){alert("Соединение закрыто или не может быть открыто")}))}},e=>{e(e.s=384)}]);